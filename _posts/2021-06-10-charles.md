---
layout:     post
title:      "Charles抓包原理"
subtitle:   ""
date:       2021-06-10 12:00:00
author:     "boredream"
catalog: false
header-style: text
tags:
- 计算机网络
- https
- tls

---

实践之前学习的计算机网络知识，尝试分析下Charles手机抓包（重点是Https）流程。  
这里以手机访问 https://www.zhihu.com 为例。重点关注密钥、证书交换等关键步骤，其它略。Charles使用方法略。  
  
  
### 简单原理
Charles作为正向代理。手机配置手动代理时，IP指向电脑，端口号8888对应Charles应用。设置后所有手机请求和服务器的响应都会经由Charles转发，在转发的过程中Charles进行中间人攻击，拿到明文。

### 详细流程
  
#### 流程图
![charles](https://github.com/boredream/boredream.github.io/blob/master/img/in-post/charles.png?raw=true)

#### 流程说明
先Tcp握手
1. 手机向Charles发起tcp3次握手连接
2. 连接成功后手机发起https接口请求
3. Charles向服务器发起tcp3次握手连接
4. 连接成功后Charles响应手机http 200连接建立

Tcp建立后，开始TLS握手
1. 手机向Charles发起TLS握手
2. Charles将手机发来的随机数等信息保存，之后用自己的参数向服务器发起真正的TLS握手
3. Charles和服务器完成握手过程，再基于服务器返回的信息重新生成随机数、秘钥、证书等返回给手机端完成握手
4. 此时Charles端持有两套对称秘钥，一个对应手机keyP，一个对应服务器keyC

传输数据
1. 后续Charles作为中间人，拦截客户端的请求，keyP解密后用keyC重新加密传给服务端
2. 服务端返回的数据也同理

### Wireshark 抓包
  
Tcp握手  
![TLS1](https://github.com/boredream/boredream.github.io/blob/master/img/in-post/tstcpcon.png?raw=true)
  
TLS握手  
![TLS2](https://github.com/boredream/boredream.github.io/blob/master/img/in-post/tstlscon.png?raw=true)


### Https安全吗？
Charles可以抓包Https，那Https还安全吗？  
  
对于大部分应用来说，Https只需要客户端验证服务端证书（银行的U盾这种是服务器跟客户端要证书），可以理解为安全性决定权在客户端。验证服务器是否安全的关键步骤是「拿着服务器给的证书去CA验证」，如果这一步明确告知你证书有问题你依然无视继续访问，则就有被中间人攻击的风险了。  
  
  
使用Charles时需要先安装证书：
1. 电脑端： 软件菜单 Help -> SSL Proxying -> Install Charles Root Certficate 在系统里安装个Charles根证书
2. 手机端： 在设置代理后用手机浏览器打开 chls.pro/ssl。Charles拦截url下发Charles根证书。手机下载证书并安装添加信任。  
  
之后在TLS握手过程中，有个关键步骤：  
当服务器返回证书给Charles时，Charles会从证书链中提取应用证书，然后生成「应用证书 -> Charles Root」 的证书链返回给客户端。客户端收到后发现根证书在自己的信任列表里，直接通过。
  
综上，Https技术上依然是安全的，除非你自己人为的乱安装未知来源证书。就像银行技术再安全，你直接把密码给别人了也歇菜。  
